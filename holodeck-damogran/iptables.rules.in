*filter

# standard chains
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
# chains for accepting incoming connections
:TCP - [0:0]
:UDP - [0:0]



# accept traffic on established connections
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# accept all local traffic
-A INPUT -i lo -j ACCEPT
# drop all invalid traffic (esp. to avoid attacks from the internet)
-A INPUT -m conntrack --ctstate INVALID -j DROP
# accept pings from everywhere
-A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
# attach chains for checking incoming connections
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A INPUT -p tcp -m tcp --syn -m conntrack --ctstate NEW -j TCP
# reject unwanted connections
-A INPUT -p tcp -j REJECT --reject-with tcp-reset
-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
-A INPUT -j REJECT --reject-with icmp-proto-unreachable

# allow public SSH
-A TCP -p tcp -m tcp --dport 22 -j ACCEPT
# allow public HTTP(S)
-A TCP -p tcp -m tcp --dport 80 -j ACCEPT
-A TCP -p tcp -m tcp --dport 443 -j ACCEPT
# allow intranet PulseAudio
-A TCP -i ${DAMOGRAN_IFACE_WLAN} -p tcp -m tcp --dport 4713 -j ACCEPT
-A TCP -i ${DAMOGRAN_IFACE_LAN} -p tcp -m tcp --dport 4713 -j ACCEPT
# allow intranet MPD
-A TCP -i ${DAMOGRAN_IFACE_WLAN} -p tcp -m tcp --dport 6600 -j ACCEPT
-A TCP -i ${DAMOGRAN_IFACE_LAN} -p tcp -m tcp --dport 6600 -j ACCEPT
# allow public Minecraft
-A TCP -p tcp -m tcp --dport 25565 -j ACCEPT

# allow intranet DNS
-A UDP -i ${DAMOGRAN_IFACE_WLAN} -p udp -m udp --dport 53 -j ACCEPT
-A UDP -i ${DAMOGRAN_IFACE_LAN} -p udp -m udp --dport 53 -j ACCEPT
# allow intranet DHCP
-A UDP -i ${DAMOGRAN_IFACE_WLAN} -p udp -m udp --sport 67:68 --dport 67:68 -j ACCEPT
-A UDP -i ${DAMOGRAN_IFACE_LAN} -p udp -m udp --sport 67:68 --dport 67:68 -j ACCEPT
# allow intranet MDNS (for PulseAudio)
-A UDP -i ${DAMOGRAN_IFACE_WLAN} -p udp -m udp --dport 5353 -j ACCEPT
-A UDP -i ${DAMOGRAN_IFACE_LAN} -p udp -m udp --dport 5353 -j ACCEPT



# accept traffic on established connections
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# accept forwarding connections from intranet to public
-A FORWARD -i ${DAMOGRAN_IFACE_WLAN} -j ACCEPT
-A FORWARD -i ${DAMOGRAN_IFACE_LAN} -j ACCEPT
# reject unwanted connections
-A FORWARD -j REJECT --reject-with icmp-host-unreachable

COMMIT
*nat

# standard chains for NAT
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# establish forwarding connections from intranet (IP range) to public (${DAMOGRAN_IFACE_WAN})
-A POSTROUTING -s ${DAMOGRAN_NET_LAN}.0/24 -o ${DAMOGRAN_IFACE_WAN} -j MASQUERADE
-A POSTROUTING -s ${DAMOGRAN_NET_WLAN}.0/24 -o ${DAMOGRAN_IFACE_WAN} -j MASQUERADE

COMMIT
