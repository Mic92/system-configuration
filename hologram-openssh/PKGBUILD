pkgname='hologram-openssh'
pkgver=1.2.0
pkgrel=2
pkgdesc='hologram: hardened OpenSSH server'
arch=('any')
url=''
license=('AGPL3')
depends=() # run-time dependencies only
source=(
    'ssh-moduli.holoscript'
    'sshd_config.holoscript'
)

install='hologram-openssh.install'

package() {
    depends=(
        'holo>=0.3'
        'openssh'
    )

    install -D -m 0755 ssh-moduli.holoscript  "${pkgdir}/holo/repo/10-openssh/etc/ssh/moduli.holoscript"
    install -D -m 0755 sshd_config.holoscript "${pkgdir}/holo/repo/10-openssh/etc/ssh/sshd_config.holoscript"

    # enable SSH daemon
    mkdir -p "${pkgdir}/etc/systemd/system/multi-user.target.wants/"
    ln -sf /usr/lib/systemd/system/sshd.service "${pkgdir}/etc/systemd/system/multi-user.target.wants/sshd.service"

    # disable weak SSH host keys by placing invalid symlinks at their location
    mkdir -p "${pkgdir}/etc/ssh/"
    for KEYFILE in ssh_host_key ssh_host_dsa_key ssh_host_ecdsa_key; do
        ln -sf "${KEYFILE}"     "${pkgdir}/etc/ssh/${KEYFILE}"
        ln -sf "${KEYFILE}.pub" "${pkgdir}/etc/ssh/${KEYFILE}.pub"
    done
}
